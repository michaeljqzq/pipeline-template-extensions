{
  "manifestVersion": 1.0,
  "extensionId": "vss-continuous-delivery-pipeline-templates-iot",
  "name": "DevOps for IoT Edge",
  "publisher": "ms",
  "version": "0.1.1",
  "description": "DevOps for IoT Edge",
  "categories": [
    "Azure Artifacts"
  ],
  "galleryFlags": [
        "System",
        "BuiltIn",
        "MultiVersion"
    ],
    "targets": [
        {
            "id": "Microsoft.VisualStudio.Services"
        }
    ],
    "files": [
        {
            "path": "Files",
            "addressable": true
        }
    ],
    "eventCallbacks": {
        "versionCheck": {
            "uri": "{{DeploymentUrl \"0000003B-0000-8888-8000-000000000000\"}}_apis/public/extensions/vdisc"
        }
    },
  "contributions": [{
      "id": "dotnet-newdevice",
      "type": "ms.vss-continuous-delivery.pipeline-template-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-templates"
      ],
      "properties": {
        "description": "i18n:Template for configuring CI/CD pipeline for Azure IoT Edge App using .NET Core",
        "attributes": {
          "hideKey": "IoTEdgePipelineTemplates",
          "codeRepositoryType": "Sample",
          "runtimeId": "ms.vss-continuous-delivery-pipeline-templates.runtime-type-dotnet",
          "frameworkId": "ms.vss-continuous-delivery-pipeline-templates.framework-type-iot-edge",
          "serviceId": "ms.vss-continuous-delivery-pipeline-templates.service-type-linux-vm-edge-device"
        },
        "parameters": {
          "imports": [
            "Files/Parameters/ArmEndpointParameters.json",
            "Files/Parameters/ContainerRegistryParameters.json",
            "Files/Parameters/IoTHubParameters.json"
          ]
        },
        "configuration": {
          "assets": [
            {
              "id": "ARMEndpoint",
              "type": "endpoint:AzureRM",
              "inputs": {
                "subscriptionId": "{{inputs.subscriptionId}}",
                "authorization": "{{inputs.azureAuth}}"
              }
            }
          ],
          "source": {
            "repository": {
              "id": "https://github.com/Azure-Samples/iot-edge-sample-dotnet",
              "defaultBranch": "master"
            }
          },
          "buildDefinition": {
            "queue": "hostedlinux",
            "templateFile": "Files/BuildDefinitionTemplates/buildIoTEdge.json",
            "variables": {
              "DEVOPS_IOTEDGE_REGISTRY_URL": {
                "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
              }
            },
            "phaseInputs": [{
              "taskInputs": [
                {
                  "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                  "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                  "resourceGroupName": "{{{inputs.resourceGroup}}}",
                  "location": "{{{inputs.containerRegistryLocation}}}",
                  "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-acr.json",
                  "overrideParameters": "-registryName {{{inputs.containerRegistryName}}} -registrySku \"{{{inputs.containerRegistrySKU}}}\" -registryLocation \"{{{inputs.containerRegistryLocation}}}\""
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8"
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                  "azureSubscriptionEndpoint": "{{{assets.ARMEndpoint}}}",
                  "azureContainerRegistry": "{\"loginServer\":\"{{{inputs.containerRegistryName}}}.azurecr.io\", \"id\" : \"/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.ContainerRegistry/registries/{{{inputs.containerRegistryName}}}\"}"
                },
                {
                  "__TaskId__": "2ff763a7-ce83-4e1f-bc89-0ae63477cebe"
                }
              ]
            }]
          },
          "releaseDefinition": {
            "environments": [{
              "name": "dev",
              "deployedResourceIds": [
                "/subscriptions/{{inputs.subscriptionId}}/resourceGroups/{{inputs.resourceGroup}}/providers/Microsoft.Compute/virtualMachines/{{{inputs.iotHubName}}}-edge-simulation",
                "/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.Devices/IotHubs/{{{inputs.iotHubName}}}"
              ],
              "variables": {
                "vmPassword": {
                  "value": "{{{#generateRandomPassword}}}{{{/generateRandomPassword}}}",
                  "isSecret": true
                },
                "DEVOPS_IOTEDGE_REGISTRY_URL": {
                  "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
                }
              },
              "templateFile": "Files/ReleaseDefinitionTemplates/deployIoTEdge.json",
              "phaseInputs": [{
                "queue": "hostedlinux",
                "taskInputs": [
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-iothub.json",
                    "overrideParameters": "-iotHubName {{{inputs.iotHubName}}} -iotHubSku \"{{{inputs.iotHubSku}}}\""
                  },
                  {
                    "__TaskId__": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "inlineScript": "(az extension add --name azure-cli-iot-ext && az iot hub device-identity show --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}}) || (az iot hub device-identity create --hub-name {{{inputs.iotHubName}}} --device-id myEdgeDevice --edge-enabled && TMP_OUTPUT=\"$(az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}})\" && RE=\"\\\"cs\\\":\\s?\\\"(.*)\\\"\" && if [[ $TMP_OUTPUT =~ $RE ]]; then CS_OUTPUT=${BASH_REMATCH[1]}; fi && echo \"##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}\")"
                  },
                  {
                    "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "iothubname": "{{inputs.iotHubName}}"
                  },
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-linux-vm.json",
                    "overrideParameters": "-edgeDeviceConnectionString $(CS_OUTPUT) -virtualMachineName \"{{{inputs.iotHubName}}}-edge-simulation\" -adminUsername \"devops\" -adminPassword \"$(vmPassword)\" -appInsightsLocation \"{{{inputs.appInsightLocation}}}\" -virtualMachineSize \"Standard_A0\" -location \"{{{inputs.iotHubLocation}}}\" "
                  }
                ]
              }]
            }]
          }
        }
      }
    },
    {
      "id": "node-newdevice",
      "type": "ms.vss-continuous-delivery.pipeline-template-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-templates"
      ],
      "properties": {
        "description": "i18n:Template for configuring CI/CD pipeline for Azure IoT Edge App using Node.js",
        "attributes": {
          "hideKey": "IoTEdgePipelineTemplates",
          "codeRepositoryType": "Sample",
          "runtimeId": "ms.vss-continuous-delivery-pipeline-templates.runtime-type-nodejs",
          "frameworkId": "ms.vss-continuous-delivery-pipeline-templates.framework-type-iot-edge",
          "serviceId": "ms.vss-continuous-delivery-pipeline-templates.service-type-linux-vm-edge-device"
        },
        "parameters": {
          "imports": [
            "Files/Parameters/ArmEndpointParameters.json",
            "Files/Parameters/ContainerRegistryParameters.json",
            "Files/Parameters/IoTHubParameters.json"
          ]
        },
        "configuration": {
          "assets": [
            {
              "id": "ARMEndpoint",
              "type": "endpoint:AzureRM",
              "inputs": {
                "subscriptionId": "{{inputs.subscriptionId}}",
                "authorization": "{{inputs.azureAuth}}"
              }
            }
          ],
          "source": {
            "repository": {
              "id": "https://github.com/Azure-Samples/iot-edge-sample-node",
              "defaultBranch": "master"
            }
          },
          "buildDefinition": {
            "queue": "hostedlinux",
            "templateFile": "Files/BuildDefinitionTemplates/buildIoTEdge.json",
            "variables": {
              "DEVOPS_IOTEDGE_REGISTRY_URL": {
                "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
              }
            },
            "phaseInputs": [{
              "taskInputs": [
                {
                  "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                  "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                  "resourceGroupName": "{{{inputs.resourceGroup}}}",
                  "location": "{{{inputs.containerRegistryLocation}}}",
                  "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-acr.json",
                  "overrideParameters": "-registryName {{{inputs.containerRegistryName}}} -registrySku \"{{{inputs.containerRegistrySKU}}}\" -registryLocation \"{{{inputs.containerRegistryLocation}}}\""
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8"
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                  "azureSubscriptionEndpoint": "{{{assets.ARMEndpoint}}}",
                  "azureContainerRegistry": "{\"loginServer\":\"{{{inputs.containerRegistryName}}}.azurecr.io\", \"id\" : \"/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.ContainerRegistry/registries/{{{inputs.containerRegistryName}}}\"}"
                },
                {
                  "__TaskId__": "2ff763a7-ce83-4e1f-bc89-0ae63477cebe"
                }
              ]
            }]
          },
          "releaseDefinition": {
            "environments": [{
              "name": "dev",
              "deployedResourceIds": [
                "/subscriptions/{{inputs.subscriptionId}}/resourceGroups/{{inputs.resourceGroup}}/providers/Microsoft.Compute/virtualMachines/{{{inputs.iotHubName}}}-edge-simulation",
                "/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.Devices/IotHubs/{{{inputs.iotHubName}}}"
              ],
              "variables": {
                "vmPassword": {
                  "value": "{{{#generateRandomPassword}}}{{{/generateRandomPassword}}}",
                  "isSecret": true
                },
                "DEVOPS_IOTEDGE_REGISTRY_URL": {
                  "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
                }
              },
              "templateFile": "Files/ReleaseDefinitionTemplates/deployIoTEdge.json",
              "phaseInputs": [{
                "queue": "hostedlinux",
                "taskInputs": [
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-iothub.json",
                    "overrideParameters": "-iotHubName {{{inputs.iotHubName}}} -iotHubSku \"{{{inputs.iotHubSku}}}\""
                  },
                  {
                    "__TaskId__": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "inlineScript": "(az extension add --name azure-cli-iot-ext && az iot hub device-identity show --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}}) || (az iot hub device-identity create --hub-name {{{inputs.iotHubName}}} --device-id myEdgeDevice --edge-enabled && TMP_OUTPUT=\"$(az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}})\" && RE=\"\\\"cs\\\":\\s?\\\"(.*)\\\"\" && if [[ $TMP_OUTPUT =~ $RE ]]; then CS_OUTPUT=${BASH_REMATCH[1]}; fi && echo \"##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}\")"
                  },
                  {
                    "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "iothubname": "{{inputs.iotHubName}}"
                  },
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-linux-vm.json",
                    "overrideParameters": "-edgeDeviceConnectionString $(CS_OUTPUT) -virtualMachineName \"{{{inputs.iotHubName}}}-edge-simulation\" -adminUsername \"devops\" -adminPassword \"$(vmPassword)\" -appInsightsLocation \"{{{inputs.appInsightLocation}}}\" -virtualMachineSize \"Standard_A0\" -location \"{{{inputs.iotHubLocation}}}\" "
                  }
                ]
              }]
            }]
          }
        }
      }
    },
    {
      "id": "java-newdevice",
      "type": "ms.vss-continuous-delivery.pipeline-template-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-templates"
      ],
      "properties": {
        "description": "i18n:Template for configuring CI/CD pipeline for Azure IoT Edge App using Java",
        "attributes": {
          "hideKey": "IoTEdgePipelineTemplates",
          "codeRepositoryType": "Sample",
          "runtimeId": "ms.vss-continuous-delivery-pipeline-templates.runtime-type-java",
          "frameworkId": "ms.vss-continuous-delivery-pipeline-templates.framework-type-iot-edge",
          "serviceId": "ms.vss-continuous-delivery-pipeline-templates.service-type-linux-vm-edge-device"
        },
        "parameters": {
          "imports": [
            "Files/Parameters/ArmEndpointParameters.json",
            "Files/Parameters/ContainerRegistryParameters.json",
            "Files/Parameters/IoTHubParameters.json"
          ]
        },
        "configuration": {
          "assets": [
            {
              "id": "ARMEndpoint",
              "type": "endpoint:AzureRM",
              "inputs": {
                "subscriptionId": "{{inputs.subscriptionId}}",
                "authorization": "{{inputs.azureAuth}}"
              }
            }
          ],
          "source": {
            "repository": {
              "id": "https://github.com/Azure-Samples/iot-edge-sample-java",
              "defaultBranch": "master"
            }
          },
          "buildDefinition": {
            "queue": "hostedlinux",
            "templateFile": "Files/BuildDefinitionTemplates/buildIoTEdge.json",
            "variables": {
              "DEVOPS_IOTEDGE_REGISTRY_URL": {
                "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
              }
            },
            "phaseInputs": [{
              "taskInputs": [
                {
                  "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                  "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                  "resourceGroupName": "{{{inputs.resourceGroup}}}",
                  "location": "{{{inputs.containerRegistryLocation}}}",
                  "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-acr.json",
                  "overrideParameters": "-registryName {{{inputs.containerRegistryName}}} -registrySku \"{{{inputs.containerRegistrySKU}}}\" -registryLocation \"{{{inputs.containerRegistryLocation}}}\""
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8"
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                  "azureSubscriptionEndpoint": "{{{assets.ARMEndpoint}}}",
                  "azureContainerRegistry": "{\"loginServer\":\"{{{inputs.containerRegistryName}}}.azurecr.io\", \"id\" : \"/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.ContainerRegistry/registries/{{{inputs.containerRegistryName}}}\"}"
                },
                {
                  "__TaskId__": "2ff763a7-ce83-4e1f-bc89-0ae63477cebe"
                }
              ]
            }]
          },
          "releaseDefinition": {
            "environments": [{
              "name": "dev",
              "deployedResourceIds": [
                "/subscriptions/{{inputs.subscriptionId}}/resourceGroups/{{inputs.resourceGroup}}/providers/Microsoft.Compute/virtualMachines/{{{inputs.iotHubName}}}-edge-simulation",
                "/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.Devices/IotHubs/{{{inputs.iotHubName}}}"
              ],
              "variables": {
                "vmPassword": {
                  "value": "{{{#generateRandomPassword}}}{{{/generateRandomPassword}}}",
                  "isSecret": true
                },
                "DEVOPS_IOTEDGE_REGISTRY_URL": {
                  "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
                }
              },
              "templateFile": "Files/ReleaseDefinitionTemplates/deployIoTEdge.json",
              "phaseInputs": [{
                "queue": "hostedlinux",
                "taskInputs": [
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-iothub.json",
                    "overrideParameters": "-iotHubName {{{inputs.iotHubName}}} -iotHubSku \"{{{inputs.iotHubSku}}}\""
                  },
                  {
                    "__TaskId__": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "inlineScript": "(az extension add --name azure-cli-iot-ext && az iot hub device-identity show --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}}) || (az iot hub device-identity create --hub-name {{{inputs.iotHubName}}} --device-id myEdgeDevice --edge-enabled && TMP_OUTPUT=\"$(az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}})\" && RE=\"\\\"cs\\\":\\s?\\\"(.*)\\\"\" && if [[ $TMP_OUTPUT =~ $RE ]]; then CS_OUTPUT=${BASH_REMATCH[1]}; fi && echo \"##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}\")"
                  },
                  {
                    "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "iothubname": "{{inputs.iotHubName}}"
                  },
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-linux-vm.json",
                    "overrideParameters": "-edgeDeviceConnectionString $(CS_OUTPUT) -virtualMachineName \"{{{inputs.iotHubName}}}-edge-simulation\" -adminUsername \"devops\" -adminPassword \"$(vmPassword)\" -appInsightsLocation \"{{{inputs.appInsightLocation}}}\" -virtualMachineSize \"Standard_A0\" -location \"{{{inputs.iotHubLocation}}}\" "
                  }
                ]
              }]
            }]
          }
        }
      }
    },
    {
      "id": "c-newdevice",
      "type": "ms.vss-continuous-delivery.pipeline-template-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-templates"
      ],
      "properties": {
        "description": "i18n:Template for configuring CI/CD pipeline for Azure IoT Edge App using C",
        "attributes": {
          "hideKey": "IoTEdgePipelineTemplates",
          "codeRepositoryType": "Sample",
          "runtimeId": "ms.vss-continuous-delivery-pipeline-templates.runtime-type-edge-c",
          "frameworkId": "ms.vss-continuous-delivery-pipeline-templates.framework-type-iot-edge",
          "serviceId": "ms.vss-continuous-delivery-pipeline-templates.service-type-linux-vm-edge-device"
        },
        "parameters": {
          "imports": [
            "Files/Parameters/ArmEndpointParameters.json",
            "Files/Parameters/ContainerRegistryParameters.json",
            "Files/Parameters/IoTHubParameters.json"
          ]
        },
        "configuration": {
          "assets": [
            {
              "id": "ARMEndpoint",
              "type": "endpoint:AzureRM",
              "inputs": {
                "subscriptionId": "{{inputs.subscriptionId}}",
                "authorization": "{{inputs.azureAuth}}"
              }
            }
          ],
          "source": {
            "repository": {
              "id": "https://github.com/Azure-Samples/iot-edge-sample-c",
              "defaultBranch": "master"
            }
          },
          "buildDefinition": {
            "queue": "hostedlinux",
            "templateFile": "Files/BuildDefinitionTemplates/buildIoTEdge.json",
            "variables": {
              "DEVOPS_IOTEDGE_REGISTRY_URL": {
                "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
              }
            },
            "phaseInputs": [{
              "taskInputs": [
                {
                  "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                  "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                  "resourceGroupName": "{{{inputs.resourceGroup}}}",
                  "location": "{{{inputs.containerRegistryLocation}}}",
                  "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-acr.json",
                  "overrideParameters": "-registryName {{{inputs.containerRegistryName}}} -registrySku \"{{{inputs.containerRegistrySKU}}}\" -registryLocation \"{{{inputs.containerRegistryLocation}}}\""
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8"
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                  "azureSubscriptionEndpoint": "{{{assets.ARMEndpoint}}}",
                  "azureContainerRegistry": "{\"loginServer\":\"{{{inputs.containerRegistryName}}}.azurecr.io\", \"id\" : \"/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.ContainerRegistry/registries/{{{inputs.containerRegistryName}}}\"}"
                },
                {
                  "__TaskId__": "2ff763a7-ce83-4e1f-bc89-0ae63477cebe"
                }
              ]
            }]
          },
          "releaseDefinition": {
            "environments": [{
              "name": "dev",
              "deployedResourceIds": [
                "/subscriptions/{{inputs.subscriptionId}}/resourceGroups/{{inputs.resourceGroup}}/providers/Microsoft.Compute/virtualMachines/{{{inputs.iotHubName}}}-edge-simulation",
                "/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.Devices/IotHubs/{{{inputs.iotHubName}}}"
              ],
              "variables": {
                "vmPassword": {
                  "value": "{{{#generateRandomPassword}}}{{{/generateRandomPassword}}}",
                  "isSecret": true
                },
                "DEVOPS_IOTEDGE_REGISTRY_URL": {
                  "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
                }
              },
              "templateFile": "Files/ReleaseDefinitionTemplates/deployIoTEdge.json",
              "phaseInputs": [{
                "queue": "hostedlinux",
                "taskInputs": [
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-iothub.json",
                    "overrideParameters": "-iotHubName {{{inputs.iotHubName}}} -iotHubSku \"{{{inputs.iotHubSku}}}\""
                  },
                  {
                    "__TaskId__": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "inlineScript": "(az extension add --name azure-cli-iot-ext && az iot hub device-identity show --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}}) || (az iot hub device-identity create --hub-name {{{inputs.iotHubName}}} --device-id myEdgeDevice --edge-enabled && TMP_OUTPUT=\"$(az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}})\" && RE=\"\\\"cs\\\":\\s?\\\"(.*)\\\"\" && if [[ $TMP_OUTPUT =~ $RE ]]; then CS_OUTPUT=${BASH_REMATCH[1]}; fi && echo \"##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}\")"
                  },
                  {
                    "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "iothubname": "{{inputs.iotHubName}}"
                  },
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-linux-vm.json",
                    "overrideParameters": "-edgeDeviceConnectionString $(CS_OUTPUT) -virtualMachineName \"{{{inputs.iotHubName}}}-edge-simulation\" -adminUsername \"devops\" -adminPassword \"$(vmPassword)\" -appInsightsLocation \"{{{inputs.appInsightLocation}}}\" -virtualMachineSize \"Standard_A0\" -location \"{{{inputs.iotHubLocation}}}\" "
                  }
                ]
              }]
            }]
          }
        }
      }
    },
    {
      "id": "python-newdevice",
      "type": "ms.vss-continuous-delivery.pipeline-template-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-templates"
      ],
      "properties": {
        "description": "i18n:Template for configuring CI/CD pipeline for Azure IoT Edge App using Python",
        "attributes": {
          "hideKey": "IoTEdgePipelineTemplates",
          "codeRepositoryType": "Sample",
          "runtimeId": "ms.vss-continuous-delivery-pipeline-templates.runtime-type-python",
          "frameworkId": "ms.vss-continuous-delivery-pipeline-templates.framework-type-iot-edge",
          "serviceId": "ms.vss-continuous-delivery-pipeline-templates.service-type-linux-vm-edge-device"
        },
        "parameters": {
          "imports": [
            "Files/Parameters/ArmEndpointParameters.json",
            "Files/Parameters/ContainerRegistryParameters.json",
            "Files/Parameters/IoTHubParameters.json"
          ]
        },
        "configuration": {
          "assets": [
            {
              "id": "ARMEndpoint",
              "type": "endpoint:AzureRM",
              "inputs": {
                "subscriptionId": "{{inputs.subscriptionId}}",
                "authorization": "{{inputs.azureAuth}}"
              }
            }
          ],
          "source": {
            "repository": {
              "id": "https://github.com/Azure-Samples/iot-edge-sample-python",
              "defaultBranch": "master"
            }
          },
          "buildDefinition": {
            "queue": "hostedlinux",
            "templateFile": "Files/BuildDefinitionTemplates/buildIoTEdge.json",
            "variables": {
              "DEVOPS_IOTEDGE_REGISTRY_URL": {
                "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
              }
            },
            "phaseInputs": [{
              "taskInputs": [
                {
                  "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                  "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                  "resourceGroupName": "{{{inputs.resourceGroup}}}",
                  "location": "{{{inputs.containerRegistryLocation}}}",
                  "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-acr.json",
                  "overrideParameters": "-registryName {{{inputs.containerRegistryName}}} -registrySku \"{{{inputs.containerRegistrySKU}}}\" -registryLocation \"{{{inputs.containerRegistryLocation}}}\""
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8"
                },
                {
                  "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                  "azureSubscriptionEndpoint": "{{{assets.ARMEndpoint}}}",
                  "azureContainerRegistry": "{\"loginServer\":\"{{{inputs.containerRegistryName}}}.azurecr.io\", \"id\" : \"/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.ContainerRegistry/registries/{{{inputs.containerRegistryName}}}\"}"
                },
                {
                  "__TaskId__": "2ff763a7-ce83-4e1f-bc89-0ae63477cebe"
                }
              ]
            }]
          },
          "releaseDefinition": {
            "environments": [{
              "name": "dev",
              "deployedResourceIds": [
                "/subscriptions/{{inputs.subscriptionId}}/resourceGroups/{{inputs.resourceGroup}}/providers/Microsoft.Compute/virtualMachines/{{{inputs.iotHubName}}}-edge-simulation",
                "/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.Devices/IotHubs/{{{inputs.iotHubName}}}"
              ],
              "variables": {
                "vmPassword": {
                  "value": "{{{#generateRandomPassword}}}{{{/generateRandomPassword}}}",
                  "isSecret": true
                },
                "DEVOPS_IOTEDGE_REGISTRY_URL": {
                  "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
                }
              },
              "templateFile": "Files/ReleaseDefinitionTemplates/deployIoTEdge.json",
              "phaseInputs": [{
                "queue": "hostedlinux",
                "taskInputs": [
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-iothub.json",
                    "overrideParameters": "-iotHubName {{{inputs.iotHubName}}} -iotHubSku \"{{{inputs.iotHubSku}}}\""
                  },
                  {
                    "__TaskId__": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "inlineScript": "(az extension add --name azure-cli-iot-ext && az iot hub device-identity show --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}}) || (az iot hub device-identity create --hub-name {{{inputs.iotHubName}}} --device-id myEdgeDevice --edge-enabled && TMP_OUTPUT=\"$(az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}})\" && RE=\"\\\"cs\\\":\\s?\\\"(.*)\\\"\" && if [[ $TMP_OUTPUT =~ $RE ]]; then CS_OUTPUT=${BASH_REMATCH[1]}; fi && echo \"##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}\")"
                  },
                  {
                    "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                    "connectedServiceNameARM": "{{{assets.ARMEndpoint}}}",
                    "iothubname": "{{inputs.iotHubName}}"
                  },
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMEndpoint}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/Azure-Samples/devops-iot-scripts/12d60bd513ead7c94aa1669e505083beaef8a480/arm-linux-vm.json",
                    "overrideParameters": "-edgeDeviceConnectionString $(CS_OUTPUT) -virtualMachineName \"{{{inputs.iotHubName}}}-edge-simulation\" -adminUsername \"devops\" -adminPassword \"$(vmPassword)\" -appInsightsLocation \"{{{inputs.appInsightLocation}}}\" -virtualMachineSize \"Standard_A0\" -location \"{{{inputs.iotHubLocation}}}\" "
                  }
                ]
              }]
            }]
          }
        }
      }
    },
    {
      "id": "framework-type-iot-edge",
      "type": "ms.vss-continuous-delivery.pipeline-attribute-descriptor-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-attribute-descriptors"
      ],
      "properties": {
        "name": "i18n:Simple IoT App",
        "description": "i18n:A fully managed service that delivers cloud intelligence locally on cross-platform IoT devices",
        "type": "framework",
        "iconSvgContent": "<svg id=\"svg-iot-hub-alt\" viewBox=\"0 0 60 60\" width=\"100%\" height=\"100%\" fill='#0078d4'> <path d=\"M 5.81243 11.6613C 9.02254 11.6613 11.6249 9.05083 11.6249 5.83065C 11.6249 2.61047 9.02254 0 5.81243 0C 2.60231 0 0 2.61047 0 5.83065C 0 9.05083 2.60231 11.6613 5.81243 11.6613Z\" transform=\"translate(19.3137 3.38562)\"></path> <path d=\"M 6.93742 13.9183C 10.7688 13.9183 13.8748 10.8026 13.8748 6.95916C 13.8748 3.11572 10.7688 0 6.93742 0C 3.10599 0 0 3.11572 0 6.95916C 0 10.8026 3.10599 13.9183 6.93742 13.9183Z\" transform=\"translate(31.5011 21.0654)\"></path> <path d=\"M 5.43744 10.909C 8.44045 10.909 10.8749 8.4669 10.8749 5.45448C 10.8749 2.44205 8.44045 0 5.43744 0C 2.43442 0 0 2.44205 0 5.45448C 0 8.4669 2.43442 10.909 5.43744 10.909Z\" transform=\"translate(44.626 43.2596)\"></path> <path d=\"M 4.68744 9.40427C 7.27625 9.40427 9.37489 7.29905 9.37489 4.70214C 9.37489 2.10522 7.27625 0 4.68744 0C 2.09864 0 0 2.10522 0 4.70214C 0 7.29905 2.09864 9.40427 4.68744 9.40427Z\" transform=\"translate(23.8108 40.2501)\"></path> <path d=\"M 4.68744 9.40427C 7.27625 9.40427 9.37489 7.29905 9.37489 4.70214C 9.37489 2.10522 7.27625 0 4.68744 0C 2.09864 0 0 2.10522 0 4.70214C 0 7.29905 2.09864 9.40427 4.68744 9.40427Z\" transform=\"translate(4.87427 25.9558)\"></path> <path d=\"M 23.1106 0L 0 0L 0 3.00308L 23.1106 3.00308L 23.1106 0Z\" transform=\"matrix(0.573895 0.818946 -0.817252 0.576305 26.1398 8.0979)\"></path> <path d=\"M 23.6805 0L 0 0L 0 3.00229L 23.6805 3.00229L 23.6805 0Z\" transform=\"matrix(0.495629 0.868569 -0.867228 0.497972 39.5942 27.0326)\"></path> <path d=\"M 3.0093 0L 0 0L 0 28.6878L 3.0093 28.6878L 3.0093 0Z\" transform=\"matrix(0.0824909 0.996621 -0.996579 0.0830053 38.0049 26.4064)\"></path> <path d=\"M 3.00247 0L 0 0L 0 19.5446L 3.00247 19.5446L 3.00247 0Z\" transform=\"matrix(0.855785 0.517285 -0.514915 0.857213 36.9539 27.1599)\"></path> <path d=\"M 16.1248 0L 0.937488 0C 0.374995 0 -7.15247e-07 0.376171 -7.15247e-07 1.12851L -7.15247e-07 6.58299C -7.15247e-07 7.14725 0.374995 7.52342 0.937488 7.52342L 9.56238 7.52342L 9.56238 15.9873C 9.56238 16.5515 9.93738 16.9277 10.6874 16.9277L 16.1248 16.9277C 16.6873 16.9277 17.0623 16.5515 17.0623 15.9873L 17.0623 0.940427C 17.0623 0.376171 16.6873 0 16.1248 0Z\" transform=\"translate(42.9377 0)\"></path> <path d=\"M 0.937489 16.9277L 16.1248 16.9277C 16.6873 16.9277 17.0623 16.5515 17.0623 15.7992L 17.0623 10.3447C 17.0623 9.78045 16.6873 9.40427 16.1248 9.40427L 7.49991 9.40427L 7.49991 0.940427C 7.49991 0.37617 7.12491 -7.17489e-07 6.37492 -7.17489e-07L 0.937489 -7.17489e-07C 0.374995 -7.17489e-07 0 0.37617 0 0.940427L 0 15.9873C 0 16.5515 0.374995 16.9277 0.937489 16.9277Z\" transform=\"translate(0 43.0714)\"></path> </svg>"
      }
    },
    {
      "id": "service-type-linux-vm-edge-device",
      "type": "ms.vss-continuous-delivery.pipeline-attribute-descriptor-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-attribute-descriptors"
      ],
      "properties": {
        "name": "i18n:IoT Edge",
        "description": "i18n:Internet of Things(IoT) service to analyze data on devices, a.k.a. \"at the edge\", instead of in the cloud.",
        "type": "resource",
        "iconSvgContent": "<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px'  viewBox='0 0 50 50' style='enable-background:new 0 0 50 50;' xml:space='preserve'>  <g>    <path fill='#017ACC' d='M47.7,35H2.3C1.6,35,1,35.6,1,36.3v12.4C1,49.4,1.6,50,2.3,50h45.4c0.7,0,1.3-0.6,1.3-1.3V36.3  C49,35.6,48.4,35,47.7,35z' />    <rect x='42' y='38' fill='#FFFFFF' opacity='0.2' enable-background='new' width='3' height='3' />    <rect x='42' y='44' fill='#FFFFFF' opacity='0.2' enable-background='new' width='3' height='3' />    <path fill='#017ACC' d='M42.5,14.8c0.4-1.1,0.6-2.3,0.6-3.5c0-6.2-5.1-11.2-11.4-11.2c-4.8,0-8.8,2.9-10.5,7c-1.5-1.6-3.7-2.6-6-2.6  C10.6,4.5,7,8.1,7,12.6c0,0.8,0.1,1.6,0.3,2.3c-3.6,1.3-6.1,4.7-6.1,8.7c0,5.1,4.2,9.3,9.4,9.3h29c5.2,0,9.4-4.2,9.4-9.3  C48.9,19.6,46.2,16.1,42.5,14.8z' />    <path fill='#FFFFFF' opacity='0.2' enable-background='new' d='M4.3,28.9c0-4.1,2.7-7.5,6.4-8.9c-0.2-0.7-0.4-1.6-0.4-2.4c0-4.6,3.8-8.3,8.6-8.3c2.5,0,4.8,1,6.3,2.6  c1.8-4.1,6-7.1,11-7.1c2,0,3.9,0.5,5.5,1.3C39.9,2.5,36,0,31.5,0C26.7,0,22.7,2.8,21,6.7c-1.5-1.5-3.7-2.5-6-2.5  c-4.6,0-8.2,3.5-8.2,7.9c0,0.8,0.1,1.6,0.3,2.3C3.5,15.7,1,19,1,22.8c0,2.7,1.3,5.2,3.3,6.9C4.3,29.5,4.3,29.2,4.3,28.9z' />    <path fill='#1E1E1E' opacity='0.2' enable-background='new' d='M41.4,25.1c-0.6-1.4-1.9-2.4-3.5-2.4c-0.5,0-0.9,0.1-1.4,0.3c-0.1,0-0.2,0.1-0.3,0.2l-3.7-3.5  c0.3-0.7,0.4-1.4,0.4-2.1c0-3-2.5-5.5-5.5-5.5c-1.5,0-2.8,0.6-3.8,1.5l-2-1.2c0-0.6,0-1.1-0.2-1.7c-0.6-1.4-1.9-2.4-3.5-2.4  c-0.5,0-0.9,0.1-1.4,0.3c-1.9,0.7-2.9,2.9-2.1,4.8c0.6,1.4,1.9,2.4,3.5,2.4l0,0c0.5,0,0.9-0.1,1.4-0.3c0.3-0.1,0.6-0.3,0.8-0.5  l2,1.2c0,0.4-0.1,0.8-0.1,1.3c0,0.6,0.1,1.2,0.3,1.7l-3.9,2.4c-0.5-0.3-1-0.4-1.6-0.4c-0.4,0-0.8,0.1-1.2,0.2  c-1.6,0.6-2.4,2.5-1.8,4.1c0.5,1.2,1.6,2,3,2l0,0c0.4,0,0.8-0.1,1.2-0.2c1.3-0.5,2-1.7,2-3l4-2.5c0.5,0.4,1.1,0.7,1.7,0.9  l-2.6,15.5c-1.8,0.6-3.1,2.3-3.1,4.3c0,2.5,2,4.5,4.5,4.5s4.5-2,4.5-4.5c0-1.9-1.2-3.5-2.9-4.2l2.6-15.4c0.7-0.2,1.4-0.4,1.9-0.8  l3.7,3.6c-0.2,0.7-0.1,1.5,0.1,2.2c0.6,1.4,1.9,2.4,3.5,2.4c0.5,0,0.9-0.1,1.4-0.3C41.2,29.2,42.2,27,41.4,25.1z' />    <path fill='#FFFFFF' enable-background='new' d='M40.5,25.5C40,24.1,38.4,23.4,37,24c-0.3,0.1-0.6,0.3-0.8,0.5l-4.8-4.6c0.4-0.7,0.7-1.5,0.7-2.3  c0-2.5-2-4.5-4.5-4.5c-1.5,0-2.8,0.7-3.6,1.8l-3.3-2.1c0.2-0.6,0.2-1.2-0.1-1.8C20,9.6,18.4,8.9,17,9.4s-2.1,2.1-1.5,3.5  c0.5,1.4,2.1,2.1,3.5,1.5c0.4-0.2,0.8-0.4,1.1-0.8l3.3,2c-0.2,0.5-0.4,1.1-0.4,1.7c0,0.8,0.2,1.5,0.5,2.1l-5.2,3.2  c-0.6-0.6-1.5-0.8-2.3-0.5c-1.1,0.4-1.7,1.7-1.2,2.8s1.7,1.7,2.8,1.2c1.1-0.4,1.6-1.5,1.3-2.6l5.3-3.3c0.7,0.8,1.6,1.3,2.7,1.4  L24.3,39c-1.8,0.1-3.3,1.6-3.3,3.5s1.6,3.5,3.5,3.5s3.5-1.6,3.5-3.5c0-1.7-1.2-3-2.7-3.4L27.9,22c1.1-0.1,2.1-0.5,2.8-1.3l4.8,4.6  c-0.3,0.7-0.3,1.4-0.1,2.1c0.5,1.4,2.1,2.1,3.5,1.5S41,26.9,40.5,25.5z' />  </g></svg>"
      }
    }
  ]
}